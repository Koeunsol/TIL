# 추천 시스템 특강 2019-10-21, 2019-10-25

### 추천 시스템 분석가 업무

이 문제를 추천으로 해결할 수 있다는 가설이 맞는 건지 확인하는 것 까지

## 추천 시스템 예시

- 공통점: 콘텐츠 수만 ~ 수백만 개
1. **왓챠**
2. **멜론**
    - Context 에 맞는 음악 추천

        `e.g.` `주말 마무리를 위한 선곡`

3. **포털**
    - 뉴스 : 포털 에 들어오는 이유`not 검색`
    - 뉴스는 4시간 안에 사람들이 못 보면 아무도 안 본다

### 검색과 추천의 차이점

공통점: 정보 전달

- 검색 Active
- 추천 Passive

## 추천 시스템 분류

1. **시나리오에 따른 분류**
    - **연관된 아이템 추천**

        현재 소비하는 아이템과 연관된 아이템 추천

        `e.g.` `카카오 맵` `많이 찾는 추천 음식점`

        `e.g.` `멜론` `유사곡 추천`

    - **개인화 아이템 추천**

        소비중인 아이템이 없더라도, 개인의 관심사를 찾아 소비할 만한 아이템을 추천

        최근 관심사 참고

        `e.g.` `11번가` `추천 @홈화면`

        👎 개인별 로그를 모두 축적해야하는데 트래픽이 많아서 쉽지 않다

2. **피드백 종류에 따른 분류**
    - **명시적 피드백을 사용하는 추천 시스템**

        `영화 평점` `좋아요` `싫어요`와 같이 소비자가 명시적으로 자신의 선호를 표현한 데이터

        `e.g.` `왓챠`

        👍 모인 데이터를 잘 해석하기만 하면 된다

        👎 데이터가 많지 않다

        👎 Negative Feedback `e.g.` `싫어요` `in Facebook` 은 애매하다. 아무것도 안 눌렀을 때 싫어하는 건지, 못 본건지

    - **암시적 피드백을 사용하는 추천 시스템**

        웹페이지 접속 기록, 음악 청취 기록(많이 듣는 노래 분류, 음악 재생 중 끈 것 등)

        `e.g.` `멜론`

        👍 명시적 데이터보다 데이터 양 자체는 훨씬 많다. 다양한 분석 적용할 수 있다

        👎 분석하는데 오래 걸린다

        👎 노이즈 핸들링이 필요하다

        `e.g.` `실제로 클릭했는지` `vs` `실수로 클릭했는지`

        `e.g.` `노래가 싫어서 끈 것인지` `vs` `노래 재생 중 친구를 만나서 껐는지`

3. **업데이트 주기에 따른 분류**

- **정적 추천 시스템**

    특정 시점의 데이터를 사용해 추천 결과를 계산

    👍 보수적이어야하는 휴면유저 푸쉬 등에 적합 

    👎 사람들은 새로운 걸 좋아한다

- **동적 추천 시스템**

    지속적으로 사용자의 데이터를 받아 추천 결과를 업데이트

### 실제 추천 시스템 만들 때 사용하는 로직

최대한 다양한 콘텐츠를 보여주고 그 안에서 유저의 선호를 확인한다

보통은 여러가지를 조합해서 쓴다

- 피드백은 보통 암시적 피드백을 쓰고 명시적 데이터가 있으면 같이 쓴다
- 연관 + 개인화 다이나믹하게 섞어서
- 정적 추천, 동적 추천

    1️⃣ 정적 추천 시스템으로 관심분야를 세팅

    2️⃣ 그 안에서 동적 추천 시스템으로 결과를 업데이트한다

### 기타 추천 예시

`e.g.` `멜론` 탈퇴하려고 하면 다음달 요금 100원으로 해준다

- 유저 분류 필요

    `스트리밍을 위해 탈퇴와 가입을 반복하는 유저` vs `진짜 떠나려는 유저`

`e.g.` `다음 앱` 휴면 유저에게 푸쉬

- 강력한 형태의 Passive 추천
- 보수적으로 접근
- 정치적인 것/성인물 등등 필터링

    `cf.` `앱 내 추천 카테고리에서는 보다 공격적인 추천이 가능`

## 추천 알고리즘

1. **Knowledge-based Filtering**

    추천하고자 하는 분야의 도메인 지식을 활용해 추천

    `e.g.` `성별/연령별로 많이 팔리는 상품을 모아 추천`

    분석결과를 활용

    `e.g.` `최근 3개 액션영화를 본 사람은 그 다음에도 액션영화를 보더라`

    👍 유저에 대한 정보가 하나도 없을 때, 랜덤보다는 나은 방법으로 판단

    👎 언제나 도메인 지식이 있지 않다

**2. Content-based Filtering**

추천하려는 아이템의 콘텐츠 정보를 분석하거나 정리된 메타정보를 활용해 콘텐츠별 특징 정보를 만들고 이를 활용해 추천

`e.g.` `액션 장르 영화 페이지 하단에 다른 액션 장르의 영화 추천`

👎 리소스가 많이 든다

**3. Collaborative Filtering** 

보통 추천시스템이라고 할 때 일컫는 가장 많이 쓰는 방법

소비자의 아이템 소비 이력을 사용해 소비하지 않은 새로운 아이템 추천

`e.g.` `영화 감상 이력을 바탕으로 좋아할 만한 영화 추천`

👍 뭔가 잘못됐을 때 원인을 찾기 쉽다

👍 Memory Based Collaborative Filtering 

- 아마존에서 만든 것
- 2002 - 2008 까지 원탑

## 추천 알고리즘 평가 방법

- **오프라인 평가 Offline Evaluation**

    사용자의 아이템에 대한 선호기록과 추천 시스템이 추천한 결과를 비교하여 추천 품질을 평가

    `e.g.` `마우스를 추천한 후에 실제로 마우스를 샀으면 추천을 잘 했다고 판단`

    👎 어떻게 만지느냐에 따라 원하는 결과를 만들 수 있다

    👎 **Self-Serving-biased** 

    - 노출이 안되서 안 산 것일 수 있다
    - 기존의 추천과 새로운 모델의 추천결과가 비슷해져서 진짜 개선되는 것인지 알 수 없다
    - 온라인 평가가 필요하다

- **온라인 평가 Online Evaluation**

    실제 오픈된 서비스에서 A/B테스트

    👍 실제 사용자의 만족도 측정 가능

    👎 비용이 비싸다 

    👎 나쁜 경험을 한 유저가 이탈할 가능성도 있다

    유저가 많은 서비스에서는 리스크를 그냥 안고 간다

    `cf.` `브런치` `트래픽이 적어서 평가가 불가능하다`

# 영화추천 시스템

## EDA

log - log scale 로 그렸을 때 직선으로 떨어지면 Power Law멱급수 데이터 라고 보면 된다

- 평점 분포 극단
- 평점 테러 필터링하기

    새로 가입해서 남기는 경우가 많다 평점 로그 1개인 경우 제외

    평점 모두 0개인 경우 제외

- 각 유저별 평점의 std
    - 분포가 0~2 사이에 몰려있다: 주는 점수만 준다

## 영화 추천 문제

소비자 u 가 평점을 남기지 않은 영화 i 에 대해 예측 평점을 계산하는 문제

## 평가 방법

- 오프라인 평가(validation set 이 있으므로)

    **RMSE Root Mean Square Error**

    RMSE 를 계산하는 rmse 함수를 만들기

## 추천 시스템 만들기

### User-User Collaborative Filtering

- 지금까지(전체 평균 평점, 유저별 평균 평점, 장르별 평균 평점)보다 좀 더 진보된 추천 방식
- 주어진 소비자와 성향이 비슷한 다른 사용자들을 찾아 그 소비자들이 남긴 평점을 바탕으로 평점 예측

1. 서로 다른 소비자 u, v 에 대해 유사한 정도를 나타내는 sim(u, v) 함수를 정의
    - **`Jaccard` `similarity`유사도 함수  `cf.` `Cosine`**
        - sim(u, v) = 교집합/합집합

            둘이 본 전체 영화 중에 둘 다 본 영화가 얼마나 되는지

2. 주어진 소비자 u 에 대해 비슷한 소비자 k 명(Uu)을 찾는다
3. 찾은 k 명의 소비자가 영화 i 에 대해 남긴 가중 평균 평점을 계산하여 소비자 u 의 예측평점으로 

- 🙋‍♀️ **과제: 왜 4번은 안되고 5번은 되는지 생각해오기**

    **`4번`**

    ![](Untitled-87d40387-b89b-4d79-a005-793bd7ba126a.png)

    **`5번`**

    ![](Untitled-5c38195c-d9a8-40ba-962a-08fc441f1791.png)

    🤦‍♀️ **생각해 본 답**

    - 개인별 평점의 표준편차가 작기 때문에
    - 개인별 평균평점에서 차이를 반영하는게 더 정확

    → 수식에 표준편차를 반영해야 한다

    '🙋‍♀️ **정답**

    - 취향이 비슷한 사람들 중 아무도 예측에 필요한 영화를 보지 않았을 때 평점이 없기 때문에 0이 나온다
    - 0이 나오지 않게 하기 위해
    - 유저 평균과 유저 평균과의 차이의 차이를 따로 구해서 더해준다

### Latent Factor Model

- 어디가서 추천시스템 공부했다고 하려면 꼭 알아야 됨
- 소비자, 아이템에 각각 **잠재**적인 특성(Latent Facor) 이 있다고 가정하고 이를 학습하고자 하는 모델
    - Latent Factor 는 주로 n 차원 벡터로 표현
- 소비자의 아이템에 대한 선호 Matrix(4x4)를 분해
    - 소비자 Matrix 2x2
    - 아이템 Matrix 2x2

`e.g.`

소비자 로맨스 좋아하고 액션 싫어함

`Pu` = (1.9, -2.4)

로맨스 성향의 영화

`Qt` = (2.7, -1.9)

**Latent Facor 로부터 계산한 예측 평점**

소비자 성향 * 영화의 특성 (내적) = 9.69

👍 **Matrix Factorization 의 장점**

- User / Item 을 표현하는 저차원 밀집 벡터 Low Dimensional Dense Vector 를 얻을 수 있다
- 다양한 머신러닝/데이터 분석 방법을 적용할 수 있다

    `차원축소`

**학습방법**

- Alternating Least Squares
- Gradient Distinct Model

## Surprise

Explicit Data 를 다룰 때 사용

`cf.` `Implicit Data`

NMF Non Matrix Factorization

# 유사 엔티티 분석

MF 를 통해 얻은 Latent Factor 로 유사한 소비자나 아이템을 찾아 분석하는 것이 가능하다

[Tensorflow 활용](https://projector.tensorflow.org/)

qi.tsv

하나의 영화가 숫자 4개로 표현된다

title.tsv

실제 제목(우리가 알아볼 수 있는 데이터)과 id 매칭

`e.g.` `카카오 선물하기`에서 아래 두가지 결과가 확연히 다르다

- 상품 검색 베이스로 유사한 유저끼리 clustering 한 것
- 구입 데이터 베이스로 유사한 유저끼리 clustering 한 것